# 番茄工作法自动计时器（macOS）PRD

## 1. 目标与范围

### 1.1 目标
- 在 macOS 上提供菜单栏番茄钟应用。
- 自动识别“工作界面”并开始计时；离开后自动暂停并保留进度。
- 工作时段可自定义；计时完成提供系统通知与菜单栏提示。
- 按天统计工作时长与番茄完成次数。

### 1.2 非目标
- 不做跨平台版本。
- 不做强依赖屏幕录制的视频内容识别。
- 不做复杂任务/项目管理功能。

## 2. 用户画像与使用场景

- 长时间在电脑上工作，希望自动化计时、减少手动操作。
- 需要在浏览器或编辑器中专注时自动计时。
- 想知道每天累计专注时长与完成的番茄次数。

## 3. 核心需求（功能）

### 3.1 自动工作界面识别
- 每 2 秒轮询一次，读取前台应用与窗口状态。
- 规则：
  - 自动启动模式下：仅当当前应用在「自动启动白名单」时，才视为工作状态。
  - 全屏且应用不在白名单 => 非工作
  - Safari 全屏 => 非工作（强制规则）
  - 其他情况 => 工作
- 忽略本应用（PomodoroAuto）的活动，避免点击菜单栏时导致计时暂停。
- 不进行屏幕录制，仅读取前台状态。
- 读取结果缓存，超限删除。

### 3.2 计时逻辑
- 进入工作界面 => 自动开始计时。
- 离开工作界面 => 自动暂停并保留进度。
- 计时完成 => 系统通知 + 菜单栏提示。
- 工作完成后自动进入休息计时（break timer）。
- 休息结束 => 通知提示并回到暂停状态。
- 支持休息期间手动切回工作（Start/Pause）。
- 支持手动清零。

### 3.3 可配置项
- 单段工作时长（分钟）。
- 单段休息时长（分钟）。
- 模式：手动启动 / 自动启动（自动开始/暂停）。
- 自动启动白名单应用列表（仅在自动启动模式下生效）。
- 全屏非工作规则开关。
- 白名单应用列表（允许全屏仍视为工作）。

### 3.4 统计
- 按天记录：
  - 累计工作秒数
  - 番茄完成次数

### 3.5 菜单栏与窗口
- 菜单栏为主入口：显示剩余时间或状态图标。
- **菜单操作**：
  - **Start/Pause**：手动开始/暂停计时器。
  - **Reset**：重置当前计时器。
  - **Stats**：打开统计窗口。
  - **Settings**：打开设置窗口。
  - **Quit**：退出应用。
- **窗口行为**：
    - 设置与统计窗口从屏幕右上角弹出，并带有淡入动画。

## 4. 体验与交互

### 4.1 菜单栏
- 默认展示剩余时间（如 25:00）。
- 状态变化：
  - 工作中：显示倒计时
  - 暂停：显示“Paused”或暂停图标
  - 完成：短暂提示并恢复为暂停

### 4.2 通知
- **工作开始**：”Pomodoro Started. Focus time begins.”
- **工作完成**：”Pomodoro Complete. Time for a break.”
- **休息开始**：”Break Started. Relax for a bit.”
- **休息结束**：”Break Over. Ready to start the next session.”

## 5. 数据与存储

### 5.1 统计存储
- Key：YYYY-MM-DD
- 字段：workSeconds, pomodoroCount

### 5.2 状态缓存
- 缓存字段：appName / bundleId / isFullscreen / timestamp
- 缓存上限：默认 1000 条或保留 24 小时
- 超限删除：FIFO

### 5.3 会话时间精准记录
- 为确保计时精准，系统会记录每次工作会话的起止时间，并累加到总工作时长中，避免因轮询间隔造成误差。

## 6. 权限与安全

- 需要辅助功能权限（Accessibility），用于读取前台窗口状态。
- 不请求屏幕录制权限。
- 不保存屏幕内容，仅保存状态记录。

## 7. 状态机

- **Idle**: 空闲状态
- **Running**: 工作计时中
- **Paused**: 暂停
- **Completed**: 工作完成
- **Resting**: 休息计时中

状态流转：
- Idle -> Running：检测到工作界面或手动开始
- Running -> Paused：检测到非工作界面或手动暂停
- Paused -> Running：再次检测到工作界面或手动开始
- Running -> Completed：工作计时结束
- Completed -> Resting：自动进入休息
- Resting -> Paused：休息计时结束或手动暂停
- 任意状态 -> Idle：手动清零

## 8. 技术方案概览

- AppKit 菜单栏：NSStatusItem
- 前台应用：NSWorkspace.shared.frontmostApplication
- 窗口/全屏：Accessibility API (AXUIElement)
- 通知：UNUserNotificationCenter
- 计时：DispatchSourceTimer 或 Timer
- 存储：UserDefaults 或本地 JSON

## 9. MVP 范围

1) 菜单栏 UI + 基础计时
2) 前台状态检测 + 全屏判定
3) 自动开始/暂停
4) 通知与按天统计
5) 缓存与清理

## 10. 迭代方向（可选）

- 更精细的视频全屏检测
- 多段计时方案与预设
- 专注白名单/黑名单细化
- 数据导出或多设备同步
